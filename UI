#!/usr/bin/env bash
# ==============================================================================
# WizyClub Feed UI Manager (TUI & CLI)
# ==============================================================================

set -euo pipefail

FILE="mobile/src/presentation/components/feed/hooks/useFeedConfig.ts"

# Renkler ve Stillere
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# İmleç Kontrolü
HIDE_CURSOR='\033[?25l'
SHOW_CURSOR='\033[?25h'

# ------------------------------------------------------------------------------
# Yardımcı Fonksiyonlar
# ------------------------------------------------------------------------------

get_flags() {
    # FEED_FLAGS objesindeki flagları ve değerlerini çeker
    sed -n '/export const FEED_FLAGS = {/,/} as const;/p' "$FILE" | grep ":" | sed 's/[,;]//g'
}

update_flag() {
    local flag="$1"
    local value="$2"
    sed -i -E "s/(${flag}:\s*)(true|false)/\1${value}/" "$FILE"
}

toggle_flag() {
    local flag="$1"
    local current_val="$2"
    local new_val="true"
    [[ "$current_val" == "true" ]] && new_val="false"
    update_flag "$flag" "$new_val"
}

# ------------------------------------------------------------------------------
# İnteraktif Menü (TUI)
# ------------------------------------------------------------------------------

interactive_menu() {
    local selected=0
    local flags=()
    local values=()

    # Terminali hazırla
    trap "echo -e '${SHOW_CURSOR}'; exit" INT TERM EXIT
    echo -ne "${HIDE_CURSOR}"

    while true; do
        # Flagları oku
        flags=()
        values=()
        while read -r line; do
            flags+=("$(echo "$line" | cut -d: -f1 | xargs)")
            values+=("$(echo "$line" | cut -d: -f2 | xargs)")
        done < <(get_flags)

        clear
        echo -e "${BLUE}${BOLD}=== WizyClub Feed UI Manager ===${NC}"
        echo -e "${CYAN}Ok tuşları ile gez, Space/Enter ile değiştir, 'q' ile çık${NC}"
        echo -e "------------------------------------------------"

        for i in "${!flags[@]}"; do
            # Türkçe Açıklamalar
            desc=""
            case "${flags[$i]}" in
                DISABLE_ALL)                  desc="[TÜMÜNÜ KAPAT] Master anahtar" ;;
                DISABLE_SCROLL_HANDLING)      desc="Kaydırma ile video değişimi" ;;
                DISABLE_INTERACTIONS)         desc="Dokunma ve etkileşimler" ;;
                DISABLE_ACTIONS)              desc="Beğeni, Paylaş, Takip butonları" ;;
                DISABLE_OVERLAYS)             desc="Header ve Story çubuğu" ;;
                DISABLE_FEED_UI_FOR_TEST)     desc="Test modu (Saf video)" ;;
                DISABLE_ACTIVE_VIDEO_OVERLAY) desc="Video üzerindeki katmanlar" ;;
                DISABLE_GLOBAL_OVERLAYS)      desc="Genel pencereler (Modallar)" ;;
                DISABLE_NON_ACTIVE_UI)        desc="Aktif olmayan video UI'ları" ;;
                *)                            desc="${flags[$i]}" ;;
            esac

            if [[ $i -eq $selected ]]; then
                # Seçili satır
                if [[ "${values[$i]}" == "false" ]]; then
                    echo -e "${YELLOW}> ${BOLD}${desc}${NC} : ${GREEN}AÇIK${NC}"
                else
                    echo -e "${YELLOW}> ${BOLD}${desc}${NC} : ${RED}KAPALI${NC}"
                fi
            else
                # Diğer satırlar
                if [[ "${values[$i]}" == "false" ]]; then
                    echo -e "  ${desc} : ${GREEN}AÇIK${NC}"
                else
                    echo -e "  ${desc} : ${RED}KAPALI${NC}"
                fi
            fi
        done
        echo -e "------------------------------------------------"

        # Klavye girdisi yakala
        read -rsn1 key
        case "$key" in
            $'\x1b') # Escape dizisi başı
                read -rsn2 -t 0.1 key_rest || key_rest=""
                case "$key_rest" in
                    "[A") # Yukarı ok
                        selected=$(( (selected - 1 + ${#flags[@]}) % ${#flags[@]} ))
                        ;;
                    "[B") # Aşağı ok
                        selected=$(( (selected + 1) % ${#flags[@]} ))
                        ;;
                esac
                ;;
            "") # Enter
                toggle_flag "${flags[$selected]}" "${values[$selected]}"
                ;;
            " ") # Space
                toggle_flag "${flags[$selected]}" "${values[$selected]}"
                ;;
            "q") # Çıkış
                break
                ;;
        esac
    done

    echo -ne "${SHOW_CURSOR}"
    clear
    echo -e "${GREEN}Değişiklikler kaydedildi.${NC}"
}

# ------------------------------------------------------------------------------
# CLI Modu (Eski kullanım desteği)
# ------------------------------------------------------------------------------

normalize_status() {
    case "${1,,}" in
        açık|acik|açik|on|open|true|1|enable|enabled) echo "false" ;;
        kapalı|kapali|kapalı|off|close|false|0|disable|disabled) echo "true" ;;
        *) echo "invalid" ;;
    esac
}

# ------------------------------------------------------------------------------
# Ana Akış
# ------------------------------------------------------------------------------

if [[ ! -f "${FILE}" ]]; then
    echo -e "${RED}Hata: Dosya bulunamadı: ${FILE}${NC}"
    exit 1
fi

if [[ $# -eq 0 ]]; then
    interactive_menu
    exit 0
fi

# Argüman varsa CLI modu çalışır
case "$1" in
    list)
        # Mevcut listeleme mantığı
        echo -e "${BLUE}=== Mevcut UI Durumu ===${NC}"
        while read -r line; do
            f=$(echo "$line" | cut -d: -f1 | xargs)
            v=$(echo "$line" | cut -d: -f2 | xargs)
            [[ "$v" == "false" ]] && echo -e "$f : ${GREEN}ON (Açık)${NC}" || echo -e "$f : ${RED}OFF (Kapalı)${NC}"
        done < <(get_flags)
        ;;
    Açık|acik|açik|on|Kapalı|kapali|kapalı|off)
        VAL=$(normalize_status "$1")
        update_flag "DISABLE_ALL" "$VAL"
        update_flag "DISABLE_FEED_UI_FOR_TEST" "$VAL"
        echo -e "Global durum güncellendi."
        ;;
    *)
        # Belirli bir flag güncelleme
        if [[ $# -eq 2 ]]; then
            VAL=$(normalize_status "$2")
            if [[ "$VAL" != "invalid" ]]; then
                update_flag "$1" "$VAL"
                echo -e "Flag '$1' güncellendi."
            fi
        else
            echo "Kullanım: UI [list | Açık | Kapalı | FLAG_NAME Açık/Kapalı]"
        fi
        ;;
esac